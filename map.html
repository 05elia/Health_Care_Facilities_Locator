<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GIS Kesehatan - Health Facility Locator </title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <style>
      /* --- CSS LAYOUT UTAMA (SAMA) --- */
      body {
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", sans-serif;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
      }
      nav {
        background: #007bff;
        height: 50px;
        display: flex;
        align-items: center;
        padding: 0 20px;
        justify-content: space-between;
        color: white;
        flex-shrink: 0;
        z-index: 2000;
      }
      .nav-logo {
        font-weight: bold;
        letter-spacing: 1px;
        text-decoration: none;
        color: white;
        font-size: 18px;
      }
      .nav-link {
        color: white;
        text-decoration: none;
        margin-left: 20px;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      #container {
        display: flex;
        flex: 1;
        height: calc(100vh - 50px);
      }
      #sidebar {
        width: 340px;
        background: #f8f9fa;
        border-right: 1px solid #ddd;
        display: flex;
        flex-direction: column;
        z-index: 1500;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      }
      .sb-header {
        padding: 15px;
        background: #0056b3;
        color: white;
      }
      .sb-content {
        padding: 15px;
        overflow-y: auto;
        flex: 1;
      }

      /* Kartu Info */
      .card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        margin-bottom: 15px;
        border-left: 4px solid #007bff;
      }
      .card h4 {
        margin: 0 0 10px;
        font-size: 14px;
        color: #333;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .stat-row {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
        margin-bottom: 5px;
        color: #555;
      }
      .val {
        font-weight: bold;
        color: #007bff;
      }

      /* Tombol Sidebar */
      .sb-footer {
        padding: 20px;
        border-top: 1px solid #ddd;
        background: #fff;
      }
      .btn-action {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: 0.3s;
        margin-bottom: 10px;
      }
      .btn-gps {
        background: #17a2b8;
        color: white;
      }
      .btn-gps:hover {
        background: #138496;
      }
      .btn-voice {
        background: linear-gradient(135deg, #6610f2, #6f42c1);
        color: white;
        box-shadow: 0 4px 10px rgba(102, 16, 242, 0.3);
      }
      .btn-voice:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(102, 16, 242, 0.4);
      }

      /* Map Area */
      #map-wrapper {
        flex: 1;
        position: relative;
      }
      #map {
        width: 100%;
        height: 100%;
      }
      #weatherCanvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1000;
      }
      .loader {
        height: 3px;
        width: 0%;
        background: #28a745;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 3000;
        transition: width 0.3s;
      }

      /* Legenda & Popup */
      .leg-item {
        font-size: 12px;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
      }
      .dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        display: inline-block;
      }
      .custom-tooltip {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid #007bff;
        border-radius: 4px;
        padding: 3px 8px;
        font-size: 11px;
        font-weight: 700;
        color: #333;
      }
      .leaflet-popup-content-wrapper {
        padding: 0;
        overflow: hidden;
        border-radius: 8px;
      }
      .leaflet-popup-content {
        margin: 0;
        width: 260px !important;
      }
      .popup-header {
        background: #007bff;
        color: white;
        padding: 10px;
        text-align: center;
      }
      .popup-header h3 {
        margin: 0;
        font-size: 14px;
        font-weight: 700;
      }
      .popup-header span {
        font-size: 11px;
        opacity: 0.9;
      }
      .popup-img-container {
        width: 100%;
        height: 130px;
        overflow: hidden;
        background: #eee;
      }
      .popup-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .popup-body {
        padding: 12px;
        text-align: center;
        font-size: 13px;
        color: #555;
      }
      .btn-rute {
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 20px;
        margin-top: 8px;
        cursor: pointer;
        font-size: 12px;
        font-weight: bold;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
      }

      /* Icons Animation */
      .pulse-icon {
        background: rgba(220, 53, 69, 0.9);
        border-radius: 50%;
        width: 100%;
        height: 100%;
        box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
        animation: pulse 2s infinite;
        border: 2px solid white;
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
      }
      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
        }
        70% {
          box-shadow: 0 0 0 15px rgba(220, 53, 69, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
        }
      }
      .gps-pulse {
        width: 20px;
        height: 20px;
        background: #007bff;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        animation: gps-wave 2s infinite;
      }
      @keyframes gps-wave {
        0% {
          box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7);
        }
        70% {
          box-shadow: 0 0 0 20px rgba(0, 123, 255, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);
        }
      }

      /* --- STYLE BARU: CHATBOT WIDGET --- */
      #chat-widget {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 3000;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
      }

      #chat-btn {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        font-size: 24px;
        cursor: pointer;
        transition: transform 0.3s;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      #chat-btn:hover {
        transform: scale(1.1);
      }

      #chat-box {
        width: 300px;
        height: 400px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        margin-bottom: 15px;
        display: none; /* Hidden default */
        flex-direction: column;
        overflow: hidden;
        animation: slideIn 0.3s ease-out;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .chat-header {
        background: #007bff;
        color: white;
        padding: 15px;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .chat-close {
        cursor: pointer;
        font-size: 18px;
      }

      .chat-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        background: #f9f9f9;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .msg {
        max-width: 80%;
        padding: 8px 12px;
        border-radius: 15px;
        font-size: 13px;
        line-height: 1.4;
        word-wrap: break-word;
      }
      .msg-bot {
        background: #e9ecef;
        color: #333;
        align-self: flex-start;
        border-bottom-left-radius: 2px;
      }
      .msg-user {
        background: #007bff;
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 2px;
      }

      .chat-input-area {
        padding: 10px;
        border-top: 1px solid #ddd;
        display: flex;
        gap: 5px;
        background: white;
      }
      #chat-input {
        flex: 1;
        border: 1px solid #ddd;
        padding: 8px;
        border-radius: 20px;
        outline: none;
        font-size: 13px;
      }
      #chat-send {
        background: #007bff;
        color: white;
        border: none;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        cursor: pointer;
      }
      /* --- ANIMATION KEYFRAMES (BARU) --- */
      @keyframes slideInLeft {
        from {
          transform: translateX(-100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes fadeInUp {
        from {
          transform: translateY(20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @keyframes popIn {
        from {
          transform: scale(0.8);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      @keyframes shimmer {
        0% {
          background-position: -200% 0;
        }
        100% {
          background-position: 200% 0;
        }
      }

      nav {
        /* Mengubah warna solid menjadi gradient */
        background: linear-gradient(90deg, #007bff, #0056b3);
        position: relative;
        overflow: hidden; /* Penting agar shimmer tidak keluar kotak */
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      /* Efek kilau cahaya berjalan */
      nav::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          to right,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        background-size: 200% 100%;
        animation: shimmer 5s infinite linear; /* Cahaya bergerak terus menerus */
        pointer-events: none;
      }

      /* Animasi Logo saat di-hover */
      .nav-logo {
        transition: transform 0.3s;
      }
      .nav-logo:hover {
        transform: scale(1.05);
      }

      /* Sidebar meluncur masuk */
      #sidebar {
        /* ...style lama... */
        animation: slideInLeft 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
      }

      /* Kartu muncul dari bawah (Fade In Up) */
      .card {
        /* ...style lama... */
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        animation: fadeInUp 0.6s ease backwards;
      }

      /* LOGIKA STAGGERING: Memberi jeda waktu muncul untuk setiap kartu */
      .card:nth-child(1) {
        animation-delay: 0.2s;
      }
      .card:nth-child(2) {
        animation-delay: 0.3s;
      }
      .card:nth-child(3) {
        animation-delay: 0.4s;
      }
      .card:nth-child(4) {
        animation-delay: 0.5s;
      }

      /* Efek saat kartu disentuh mouse */
      .card:hover {
        transform: translateY(-3px); /* Naik sedikit */
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .btn-action {
        /* Transisi halus untuk semua perubahan */
        transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
      }

      /* Efek saat tombol DITEKAN (Klik tahan) */
      .btn-action:active {
        transform: scale(0.96); /* Mengecil sedikit (efek per) */
      }

      /* Efek Hover tombol rute */
      .btn-rute:hover {
        background: #218838;
        transform: scale(1.03); /* Membesar sedikit */
      }

      /* Target kelas bawaan Leaflet */
      .leaflet-popup {
        animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      /* Gambar di dalam popup bisa di-zoom */
      .popup-img {
        transition: transform 0.5s;
      }
      .popup-img:hover {
        transform: scale(1.1);
      }

      .loader {
        /* Warna gradient */
        background: linear-gradient(90deg, #28a745, #a3cfbb);
        transition: width 0.4s ease-out; /* Gerakan loading bar lebih mulus */
        box-shadow: 0 0 10px rgba(40, 167, 69, 0.5); /* Efek glow */
      }
    </style>
  </head>
  <body>
    <div class="loader" id="loader"></div>
    <nav>
      <a href="index.html" class="nav-logo">GIS KESEHATAN</a>
      <div>
        <a href="about.html" class="nav-link"
          ><i class="fas fa-users"></i> Team</a
        >
      </div>
    </nav>

    <div id="container">
      <aside id="sidebar">
        <div class="sb-header">
          <h3 style="margin: 0; font-size: 16px">Dashboard Analisis</h3>
          <small>RSUD R. Syamsudin (Bunut)</small>
        </div>

        <div class="sb-content">
          <button onclick="getGPSLocation()" class="btn-action btn-gps">
            <i class="fas fa-crosshairs"></i> Lokasi Saya (GPS)
          </button>

          <button onclick="startVoiceCommand()" class="btn-action btn-voice">
            <i class="fas fa-microphone"></i> Perintah Suara
          </button>
          <p
            id="voiceStatus"
            style="
              font-size: 11px;
              color: #666;
              text-align: center;
              margin-top: 0;
              display: none;
            "
          >
            Mendengarkan...
          </p>

          <div class="card" style="border-left-color: #6610f2">
            <h4><i class="fas fa-info-circle"></i> Petunjuk</h4>
            <p style="font-size: 12px; margin: 0; line-height: 1.5">
              1. <b>GPS</b> untuk akurasi.<br />
              2. Klik Faskes untuk rute.
            </p>
          </div>

          <div
            class="card"
            id="route-panel"
            style="display: none; border-left-color: #28a745"
          >
            <h4><i class="fas fa-route"></i> Hasil Rute</h4>
            <div class="stat-row">
              <span>Tujuan:</span> <span class="val" id="res-dest">-</span>
            </div>
            <div class="stat-row">
              <span>Jarak:</span> <span class="val" id="res-dist">0 km</span>
            </div>
            <div class="stat-row">
              <span>Waktu:</span> <span class="val" id="res-time">0 min</span>
            </div>
          </div>

          <div class="card" style="border-left-color: #ffc107">
            <h4><i class="fas fa-layer-group"></i> Legenda</h4>
            <div class="leg-item">
              <span class="dot" style="background: red"></span> RS Bunut (Pusat)
            </div>
            <div class="leg-item">
              <span class="dot" style="background: #007bff"></span> Lokasi Anda
            </div>
            <div class="leg-item">
              <span class="dot" style="background: #d62728"></span> Rumah Sakit
              Lain
            </div>
            <div class="leg-item">
              <span class="dot" style="background: #28a745"></span> Apotek
            </div>
            <div class="leg-item">
              <span class="dot" style="background: rgba(255, 0, 0, 0.2)"></span>
              Radius Buffer
            </div>
          </div>
        </div>
      </aside>

      <div id="map-wrapper">
        <canvas id="weatherCanvas"></canvas>
        <div id="map"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
      // ==========================================
      // 1. KONFIGURASI UTAMA
      // ==========================================
      const rsBunutCoords = [-6.9148, 106.9352]; // Titik Pusat Sukabumi/RS Bunut

      // ==========================================
      // 2. SETUP PETA & LAYER DASAR (BASEMAP)
      // ==========================================

      // a. Peta Jalan (OSM)
      const streetMap = L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        {
          attribution: "&copy; OpenStreetMap",
          maxZoom: 19,
        }
      );

      // b. Peta Satelit (Esri)
      const satelitMap = L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        {
          attribution: "&copy; Esri",
          maxZoom: 19,
        }
      );

      // Inisialisasi Map (Default pakai Street Map)
      const map = L.map("map", {
        center: rsBunutCoords,
        zoom: 14,
        zoomControl: false,
        layers: [streetMap], // Layer awal yg muncul
      });

      // Pindah Zoom Control ke kanan atas
      L.control.zoom({ position: "topright" }).addTo(map);

      // ==========================================
      // 3. LAYER GRUP (OVERLAYS)
      // ==========================================
      const layers = {
        rsBunut: L.layerGroup().addTo(map), // Default: Nyala
        faskes: L.layerGroup().addTo(map), // Default: Nyala
        buffer1: L.layerGroup().addTo(map), // Default: Nyala
        buffer3: L.layerGroup().addTo(map), // Default: Nyala
        buffer5: L.layerGroup().addTo(map), // Default: Nyala
        rain: L.layerGroup(), // Default: Mati
      };

      // --- ISI KONTEN KE LAYER GRUP ---

      // A. Marker RS Bunut (Pusat)
      const iconBunut = L.divIcon({
        className: "custom-div-icon",
        html: "<div class='pulse-icon'><i class='fas fa-hospital'></i></div>",
        iconSize: [30, 30],
        iconAnchor: [15, 15],
      });

      L.marker(rsBunutCoords, { icon: iconBunut })
        .bindPopup(
          `
            <div class="popup-img-container"><img src="https://rsudsyamsudin.org/assets/images/slider/slider-1.jpg" class="popup-img"></div>
            <div class="popup-header"><h3>RSUD R. Syamsudin, SH.</h3><span>Pusat Rujukan Utama</span></div>
            <div class="popup-body"><button class="btn-rute" onclick="manualRoute('RS BUNUT')">Rute ke Sini</button></div>
        `
        )
        .addTo(layers.rsBunut);

      // B. Lingkaran Buffer (Radius)
      // 1 KM (Hijau)
      L.circle(rsBunutCoords, {
        radius: 1000,
        color: "transparent",
        fillColor: "#28a745",
        fillOpacity: 0.1,
        interactive: false,
      }).addTo(layers.buffer1);
      // 3 KM (Kuning)
      L.circle(rsBunutCoords, {
        radius: 3000,
        color: "transparent",
        fillColor: "#ffc107",
        fillOpacity: 0.1,
        interactive: false,
      }).addTo(layers.buffer3);
      // 5 KM (Merah)
      L.circle(rsBunutCoords, {
        radius: 5000,
        color: "transparent",
        fillColor: "#dc3545",
        fillOpacity: 0.1,
        interactive: false,
      }).addTo(layers.buffer5);

      // ==========================================
      // 4. KONTROL LAYER (MENU PILIHAN)
      // ==========================================
      const baseMaps = {
        "Peta Jalan": streetMap,
        Satelit: satelitMap,
      };

      const overlayMaps = {
        "<b style='color:#007bff'>RS Bunut (Pusat)</b>": layers.rsBunut,
        "Faskes Lain": layers.faskes,
        "Efek Hujan": layers.rain,
        "Buffer Radius 1 KM": layers.buffer1,
        "Buffer Radius 3 KM": layers.buffer3,
        "Buffer Radius 5 KM": layers.buffer5,
      };

      // Tambahkan Menu ke Pojok Kanan Atas
      L.control.layers(baseMaps, overlayMaps, { collapsed: true }).addTo(map);

      // ==========================================
      // 5. LOAD DATA FASKES (GEOJSON)
      // ==========================================
      let facilities = [
        { lat: rsBunutCoords[0], lng: rsBunutCoords[1], name: "RS BUNUT" },
      ];

      fetch("faskes-sukabumi.geojson")
        .then((r) => r.json())
        .then((data) => {
          let uniqueNames = new Set();
          L.geoJSON(data, {
            filter: (f) => {
              if (!f.properties.name) return false;
              let clean = f.properties.name.trim().toLowerCase();
              if (uniqueNames.has(clean)) return false;
              uniqueNames.add(clean);
              return true;
            },
            pointToLayer: (f, latlng) => {
              let type = f.properties.amenity || "clinic";
              let color =
                type === "hospital"
                  ? "#d62728"
                  : type === "pharmacy"
                  ? "#28a745"
                  : "#007bff";

              // Simpan ke array facilities buat routing
              facilities.push({
                lat: latlng.lat,
                lng: latlng.lng,
                name: f.properties.name,
              });

              return L.circleMarker(latlng, {
                radius: type === "hospital" ? 8 : 6,
                fillColor: color,
                color: "#fff",
                weight: 1,
                fillOpacity: 0.9,
              });
            },
            onEachFeature: (f, layer) => {
              let name = f.properties.name;
              layer.bindPopup(
                `<div class="popup-header"><h3>${name}</h3></div><div class="popup-body"><button class="btn-rute" onclick="manualRoute('${name}')">Rute ke Sini</button></div>`
              );
            },
          }).addTo(layers.faskes);
        })
        .catch((err) => console.log("Gagal load GeoJSON:", err));

      // ==========================================
      // 6. FUNGSI PENDUKUNG (ROUTING & GPS)
      // ==========================================

      let userMarker, routeLine, gpsCircle;

      // Fungsi Cek Lokasi GPS
      function getGPSLocation() {
        if (!navigator.geolocation) return alert("Browser tidak support GPS");

        // Tampilkan loading bar (jika ada elemen loader)
        const loader = document.getElementById("loader");
        if (loader) loader.style.width = "50%";

        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const latlng = [pos.coords.latitude, pos.coords.longitude];
            if (loader) loader.style.width = "0%";

            map.setView(latlng, 15);
            if (gpsCircle) map.removeLayer(gpsCircle);
            if (userMarker) map.removeLayer(userMarker);

            userMarker = L.marker(latlng, {
              draggable: true,
              icon: L.divIcon({
                className: "gps-icon",
                html: '<div class="gps-pulse"></div>',
                iconSize: [20, 20],
              }),
            })
              .addTo(map)
              .bindPopup("Lokasi Anda")
              .openPopup();

            gpsCircle = L.circle(latlng, {
              radius: pos.coords.accuracy,
              color: "#007bff",
              fillOpacity: 0.1,
            }).addTo(map);

            // Cari RS terdekat otomatis saat GPS didapat
            findNearestAndRoute(latlng);
          },
          (err) => {
            if (loader) loader.style.width = "0%";
            alert("Gagal ambil lokasi. Pastikan GPS aktif.");
          },
          { enableHighAccuracy: true }
        );
      }

      // Hitung Rute via OSRM
      function calculateRoute(start, end, destName) {
        if (routeLine) map.removeLayer(routeLine);
        const url = `https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson`;

        fetch(url)
          .then((r) => r.json())
          .then((d) => {
            if (!d.routes || !d.routes.length) return;
            routeLine = L.geoJSON(d.routes[0].geometry, {
              style: { color: "#007bff", weight: 6, opacity: 0.8 },
            }).addTo(map);

            // Update Panel Info (jika elemen route-panel ada di HTML)
            const panel = document.getElementById("route-panel");
            if (panel) {
              panel.style.display = "block";
              document.getElementById("res-dest").innerText = destName;
              document.getElementById("res-dist").innerText =
                (d.routes[0].distance / 1000).toFixed(2) + " km";
              document.getElementById("res-time").innerText =
                Math.ceil(d.routes[0].duration / 60) + " min";
            }
          });
      }

      // Logika Cari Faskes Terdekat
      function findNearestAndRoute(latlng) {
        let nearest = null,
          minDist = Infinity;
        let uLat = latlng.lat || latlng[0];
        let uLng = latlng.lng || latlng[1];

        facilities.forEach((f) => {
          let d = map.distance([uLat, uLng], [f.lat, f.lng]);
          if (d < minDist) {
            minDist = d;
            nearest = f;
          }
        });

        if (nearest)
          calculateRoute(
            { lat: uLat, lng: uLng },
            { lat: nearest.lat, lng: nearest.lng },
            nearest.name
          );
      }

      // Fungsi Trigger Manual dari Tombol Popup
      window.manualRoute = function (destName) {
        if (!userMarker) {
          alert("Mohon aktifkan GPS atau klik lokasi anda di peta dulu!");
          getGPSLocation();
          return;
        }
        const target = facilities.find((x) => x.name === destName);
        if (target) {
          calculateRoute(
            userMarker.getLatLng(),
            { lat: target.lat, lng: target.lng },
            destName
          );
        }
      };

      // ==========================================
      // 7. EFEK HUJAN (CANVAS)
      // ==========================================
      let animId,
        ctx = document.getElementById("weatherCanvas").getContext("2d");

      // Listener saat layer 'Efek Hujan' diceklis/uncheck
      map.on("overlayadd", (e) => {
        if (e.name === "Efek Hujan") startRain();
      });
      map.on("overlayremove", (e) => {
        if (e.name === "Efek Hujan") stopRain();
      });

      function startRain() {
        const c = document.getElementById("weatherCanvas");
        const wrapper = document.getElementById("map-wrapper");

        // Fallback kalau wrapper gak ada, pake body
        let w = (c.width = wrapper ? wrapper.offsetWidth : window.innerWidth);
        let h = (c.height = wrapper
          ? wrapper.offsetHeight
          : window.innerHeight);

        let drops = Array.from({ length: 300 }, () => ({
          x: Math.random() * w,
          y: Math.random() * h,
          speed: Math.random() * 10 + 10,
        }));

        function draw() {
          ctx.clearRect(0, 0, w, h);
          ctx.strokeStyle = "rgba(174,194,224,0.6)";
          ctx.lineWidth = 1;

          drops.forEach((d) => {
            d.y += d.speed;
            if (d.y > h) d.y = -10;
            ctx.beginPath();
            ctx.moveTo(d.x, d.y);
            ctx.lineTo(d.x, d.y + 10);
            ctx.stroke();
          });
          animId = requestAnimationFrame(draw);
        }
        draw();
      }

      function stopRain() {
        cancelAnimationFrame(animId);
        ctx.clearRect(0, 0, 5000, 5000);
      }

      // Listener Klik Peta buat set Lokasi Manual
      map.on("click", (e) => {
        if (userMarker) map.removeLayer(userMarker);
        userMarker = L.marker(e.latlng, { draggable: true })
          .addTo(map)
          .bindPopup("Lokasi Manual")
          .openPopup();
        findNearestAndRoute(e.latlng);
      });
    </script>
  </body>
</html>
